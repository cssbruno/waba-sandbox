<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>WABA Sandbox</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 2rem;
        background: #0b1723;
        color: #f5f5f5;
      }
      h1,
      h2 {
        margin-top: 0;
      }
      .muted {
        color: #9ca3af;
        font-size: 0.9rem;
      }
      .card {
        background: #111827;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      }
      label {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        color: #9ca3af;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 0.6rem 0.7rem;
        border-radius: 6px;
        border: 1px solid #374151;
        background: #020617;
        color: #f9fafb;
        font-size: 0.95rem;
        box-sizing: border-box;
        margin-bottom: 0.75rem;
      }
      input[type="checkbox"] {
        width: auto;
        margin-right: 0.25rem;
      }
      button {
        padding: 0.6rem 1.1rem;
        border-radius: 6px;
        border: none;
        background: #22c55e;
        color: #022c22;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.95rem;
      }
      button:disabled {
        background: #4b5563;
        cursor: not-allowed;
      }
      code {
        font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        font-size: 0.9rem;
        background: #020617;
        padding: 0.25rem 0.4rem;
        border-radius: 4px;
      }
      pre {
        background: #020617;
        padding: 0.75rem;
        border-radius: 6px;
        overflow-x: auto;
        max-height: 260px;
        border: 1px solid #1f2933;
      }
      .row {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
      }
      .col {
        flex: 1 1 280px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.8rem;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        background: #1d4ed8;
      }
      .badge span {
        opacity: 0.8;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        padding: 0.15rem 0.6rem;
        border-radius: 999px;
        font-size: 0.75rem;
        background: #0f766e;
        color: #a7f3d0;
        margin-right: 0.35rem;
      }
      .events-list {
        max-height: 320px;
        overflow-y: auto;
        font-size: 0.85rem;
      }
      .event-row {
        border-bottom: 1px solid #1f2937;
        padding: 0.5rem 0;
      }
      .event-header {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-bottom: 0.15rem;
      }
      .event-time {
        color: #9ca3af;
        font-size: 0.8rem;
      }
      .event-type {
        font-weight: 600;
      }
      .event-direction {
        font-size: 0.75rem;
        padding: 0.1rem 0.4rem;
        border-radius: 999px;
        text-transform: uppercase;
      }
      .event-direction.inbound {
        background: #1d4ed8;
      }
      .event-direction.outbound {
        background: #16a34a;
      }
      .event-direction.system {
        background: #9333ea;
      }
      .event-source {
        color: #9ca3af;
        font-size: 0.8rem;
      }
      .event-payload {
        white-space: pre;
        font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        background: #020617;
        border-radius: 4px;
        padding: 0.4rem 0.5rem;
        margin: 0.1rem 0 0.2rem;
      }
      .section-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
      }
      .tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }
      .tab {
        padding: 0.3rem 0.8rem;
        border-radius: 999px;
        border: 1px solid #1f2937;
        font-size: 0.85rem;
        cursor: pointer;
        background: #020617;
        color: #e5e7eb;
      }
      .tab.active {
        background: #1d4ed8;
        border-color: #1d4ed8;
        color: #eff6ff;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>WhatsApp Business (WABA) Sandbox</h1>
    <p class="muted">
      Local simulator for
      <a
        href="https://developers.facebook.com/docs/whatsapp/cloud-api/overview"
        target="_blank"
        rel="noreferrer"
        >WhatsApp Cloud API</a
      >
      webhooks. It runs on
      <code>http://localhost:3737</code> and forwards simulated events to your
      own application.
    </p>

    <div class="tabs">
      <button class="tab active" data-tab="config">Config & Auth</button>
      <button class="tab" data-tab="simulate">Simulate Messages</button>
      <button class="tab" data-tab="templates">Message Templates</button>
      <button class="tab" data-tab="numbers">Phone Numbers & Overrides</button>
      <button class="tab" data-tab="events">Live Traffic</button>
    </div>

    <div class="tab-content active" id="tab-config">
      <div class="card">
      <div class="section-title">
        <h2>1. Runtime configuration</h2>
        <span class="muted">No .env files – everything is in‑memory.</span>
      </div>
      <form id="config-form">
        <label for="targetWebhookUrl">Target webhook URL</label>
        <input
          id="targetWebhookUrl"
          name="targetWebhookUrl"
          placeholder="http://localhost:4000/webhook/whatsapp"
        />

        <label for="verifyToken">Verify token (for GET /webhook)</label>
        <input
          id="verifyToken"
          name="verifyToken"
          placeholder="sandbox-verify-token"
        />

        <label for="authMode">Simulation auth mode</label>
        <select id="authMode" name="authMode">
          <option value="none">None (no Authorization required)</option>
          <option value="jwt">JWT (Authorization: Bearer)</option>
        </select>

        <label for="jwtIssuer">JWT issuer (iss)</label>
        <input
          id="jwtIssuer"
          name="jwtIssuer"
          placeholder="waba-sandbox"
        />

        <label for="jwtAudience">JWT audience (aud)</label>
        <input
          id="jwtAudience"
          name="jwtAudience"
          placeholder="sandbox-client"
        />

        <label for="jwtSecret">JWT shared secret (sandbox only)</label>
        <input
          id="jwtSecret"
          name="jwtSecret"
          type="password"
          placeholder="sandbox-secret"
        />

        <label for="clientAuthToken">Client auth token (used by UI & curl)</label>
        <input
          id="clientAuthToken"
          name="clientAuthToken"
          placeholder="Paste or generate a JWT for Authorization: Bearer"
        />

        <button type="submit">Save configuration</button>
        <button id="generateTokenButton" type="button">
          Generate sample JWT
        </button>
        <span id="config-status" class="muted"></span>
        <span id="auth-status" class="muted"></span>
      </form>
      <p class="muted" style="margin-top: 0.75rem">
        Use
        <code>http://localhost:3737/webhook</code>
        as the callback URL in your app. Set the verify token above and reuse it
        when Meta calls your verification endpoint. When you switch the auth
        mode to <code>JWT</code>, all <code>/simulate/*</code> and
        <code>/api/config</code> calls require an
        <code>Authorization: Bearer &lt;token&gt;</code> header. You can
        generate a sandbox token with the button above and reuse it in your own
        curl requests.
      </p>
      </div>
    </div>

    <div class="tab-content" id="tab-simulate">
      <div class="row">
      <div class="col">
        <div class="card">
          <h2>
            2. Text message
            <span class="badge"
              ><strong>POST</strong> <span>/simulate/message</span></span
            >
          </h2>
          <form id="message-form">
            <label for="from">From (user phone)</label>
            <input
              id="from"
              name="from"
              placeholder="5511999999999"
              required
            />

            <label for="body">Text body</label>
            <textarea
              id="body"
              name="body"
              rows="3"
              placeholder="Hello from the sandbox!"
              required
            ></textarea>

            <label for="name">Contact name (optional)</label>
            <input id="name" name="name" placeholder="Sandbox User" />

            <label for="waId">WA ID (defaults to from)</label>
            <input id="waId" name="waId" placeholder="5511999999999" />

            <button type="submit">Send text message</button>
          </form>
        </div>

        <div class="card">
          <h2>
            3. Status update
            <span class="badge"
              ><strong>POST</strong> <span>/simulate/status</span></span
            >
          </h2>
          <form id="status-form">
            <label for="messageId">Message ID</label>
            <input
              id="messageId"
              name="messageId"
              placeholder="wamid.SANDBOX-..."
              required
            />

            <label for="recipientId">Recipient ID (user WA ID)</label>
            <input
              id="recipientId"
              name="recipientId"
              placeholder="5511999999999"
              required
            />

            <label for="status">Status</label>
            <select id="status" name="status" required>
              <option value="sent">sent</option>
              <option value="delivered">delivered</option>
              <option value="read">read</option>
              <option value="failed">failed</option>
            </select>

            <button type="submit">Send status</button>
          </form>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h2>
            4. Image message
            <span class="badge"
              ><strong>POST</strong> <span>/simulate/image</span></span
            >
          </h2>
          <form id="image-form">
            <label for="fromImage">From (user phone)</label>
            <input
              id="fromImage"
              name="fromImage"
              placeholder="5511999999999"
              required
            />

            <label for="captionImage">Caption</label>
            <input
              id="captionImage"
              name="captionImage"
              placeholder="Sample image from sandbox"
            />

            <label for="mediaUrlImage">Media URL</label>
            <input
              id="mediaUrlImage"
              name="mediaUrlImage"
              placeholder="http://localhost:3737/media/sample-image.png"
            />

            <button type="submit">Send image message</button>
          </form>
        </div>

        <div class="card">
          <h2>
            5. Document (PDF)
            <span class="badge"
              ><strong>POST</strong> <span>/simulate/document</span></span
            >
          </h2>
          <form id="document-form">
            <label for="fromDocument">From (user phone)</label>
            <input
              id="fromDocument"
              name="fromDocument"
              placeholder="5511999999999"
              required
            />

            <label for="filenameDocument">Filename</label>
            <input
              id="filenameDocument"
              name="filenameDocument"
              placeholder="sample-document.pdf"
            />

            <label for="captionDocument">Caption</label>
            <input
              id="captionDocument"
              name="captionDocument"
              placeholder="Sample document from sandbox"
            />

            <label for="mediaUrlDocument">Media URL</label>
            <input
              id="mediaUrlDocument"
              name="mediaUrlDocument"
              placeholder="http://localhost:3737/media/sample-document.pdf"
            />

            <button type="submit">Send document message</button>
          </form>
        </div>

        <div class="card">
          <h2>
            6. Audio message
            <span class="badge"
              ><strong>POST</strong> <span>/simulate/audio</span></span
            >
          </h2>
          <form id="audio-form">
            <label for="fromAudio">From (user phone)</label>
            <input
              id="fromAudio"
              name="fromAudio"
              placeholder="5511999999999"
              required
            />

            <label for="mediaUrlAudio">Media URL</label>
            <input
              id="mediaUrlAudio"
              name="mediaUrlAudio"
              placeholder="http://localhost:3737/media/sample-audio.ogg"
            />

            <label>
              <input type="checkbox" id="voiceAudio" name="voiceAudio" />
              Voice note
            </label>

            <button type="submit">Send audio message</button>
          </form>
        </div>
      </div>
      </div>

      <div class="card">
        <h2>Last HTTP response</h2>
        <pre id="output">No requests yet.</pre>
      </div>
    </div>

    <div class="tab-content" id="tab-templates">
      <div class="row">
        <div class="col">
          <div class="card">
            <div class="section-title">
              <h2>Message templates</h2>
              <span class="muted">Create, edit and delete templates.</span>
            </div>
            <div id="templates-list" class="events-list"></div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <h2>Template editor</h2>
            <form id="template-form">
              <input type="hidden" id="templateId" />

              <label for="templateName">Name</label>
              <input
                id="templateName"
                name="templateName"
                placeholder="order_update"
                required
              />

              <label for="templateLanguage">Language code</label>
              <input
                id="templateLanguage"
                name="templateLanguage"
                placeholder="en_US"
                required
              />

              <label for="templateCategory">Category</label>
              <select id="templateCategory" name="templateCategory">
                <option value="UTILITY">UTILITY</option>
                <option value="MARKETING">MARKETING</option>
                <option value="AUTHENTICATION">AUTHENTICATION</option>
                <option value="UNKNOWN">UNKNOWN</option>
              </select>

              <label for="templateHeader">Header text (optional)</label>
              <input
                id="templateHeader"
                name="templateHeader"
                placeholder="Your order update"
              />

              <label for="templateBody">Body text</label>
              <textarea
                id="templateBody"
                name="templateBody"
                rows="4"
                placeholder="Hi {{1}}, your order {{2}} is confirmed."
                required
              ></textarea>

              <label for="templateFooter">Footer text (optional)</label>
              <input
                id="templateFooter"
                name="templateFooter"
                placeholder="Thank you!"
              />

              <button type="submit">Save template</button>
              <button id="templateReset" type="button">Reset form</button>
              <span id="templateStatus" class="muted"></span>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tab-numbers">
      <div class="row">
        <div class="col">
          <div class="card">
            <div class="section-title">
              <h2>Phone numbers</h2>
              <span class="muted">Register and inspect numbers.</span>
            </div>
            <div id="phones-list" class="events-list"></div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <h2>Register / update phone</h2>
            <form id="phone-form">
              <label for="phoneId">Business phone number ID</label>
              <input
                id="phoneId"
                name="phoneId"
                placeholder="106540352242922"
                required
              />

              <label for="phoneDisplay">Display phone number</label>
              <input
                id="phoneDisplay"
                name="phoneDisplay"
                placeholder="+1 650-555-0000"
                required
              />

              <label for="phoneWabaId">WABA ID (optional)</label>
              <input
                id="phoneWabaId"
                name="phoneWabaId"
                placeholder="102290129340398"
              />

              <button type="submit">Save phone</button>
              <span id="phoneStatus" class="muted"></span>
            </form>
          </div>

          <div class="card">
            <h2>Overrides</h2>
            <form id="phoneOverrideForm">
              <label for="phoneOverrideId">Phone ID</label>
              <input
                id="phoneOverrideId"
                name="phoneOverrideId"
                placeholder="106540352242922"
                required
              />

              <label for="phoneOverrideUrl">Phone override callback URL</label>
              <input
                id="phoneOverrideUrl"
                name="phoneOverrideUrl"
                placeholder="https://my-phone-alt-callback/webhook"
              />

              <label for="phoneOverrideToken">Phone override verify token</label>
              <input
                id="phoneOverrideToken"
                name="phoneOverrideToken"
                placeholder="myvoiceismypassport?"
              />

              <button type="submit">Save phone override</button>
            </form>

            <form id="wabaOverrideForm" style="margin-top: 1rem">
              <label for="wabaId">WABA ID</label>
              <input
                id="wabaId"
                name="wabaId"
                placeholder="102290129340398"
                required
              />

              <label for="wabaOverrideUrl">WABA override callback URL</label>
              <input
                id="wabaOverrideUrl"
                name="wabaOverrideUrl"
                placeholder="https://my-waba-alt-callback/webhook"
              />

              <label for="wabaOverrideToken">WABA override verify token</label>
              <input
                id="wabaOverrideToken"
                name="wabaOverrideToken"
                placeholder="myvoiceismypassport?"
              />

              <button type="submit">Save WABA override</button>
              <span id="overrideStatus" class="muted"></span>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tab-events">
      <div class="row">
        <div class="col">
          <div class="card">
            <div class="section-title">
              <h2>Live traffic</h2>
              <span id="events-status" class="muted">Connecting…</span>
            </div>
            <div class="events-list" id="events-list"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function postJson(path, body) {
        const res = await fetch(path, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...authHeaders(),
          },
          body: JSON.stringify(body),
        });
        const text = await res.text();
        try {
          return {
            ok: res.ok,
            status: res.status,
            data: JSON.stringify(JSON.parse(text), null, 2),
          };
        } catch (_) {
          return { ok: res.ok, status: res.status, data: text };
        }
      }

      async function putJson(path, body) {
        const res = await fetch(path, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            ...authHeaders(),
          },
          body: JSON.stringify(body),
        });
        return res.json();
      }

      async function getJson(path) {
        const res = await fetch(path, {
          headers: authHeaders(),
        });
        return res.json();
      }

      const output = document.getElementById("output");

      const authTokenInput = document.getElementById("clientAuthToken");
      const authStatus = document.getElementById("auth-status");

      function getAuthToken() {
        if (!authTokenInput) return null;
        const value = authTokenInput.value.trim();
        return value ? value : null;
      }

      function authHeaders() {
        const token = getAuthToken();
        return token ? { Authorization: "Bearer " + token } : {};
      }

      (function initAuthToken() {
        if (!authTokenInput) return;
        const stored = window.localStorage.getItem("sandboxAuthToken");
        if (stored) {
          authTokenInput.value = stored;
        }
        authTokenInput.addEventListener("input", () => {
          const value = getAuthToken();
          if (value) {
            window.localStorage.setItem("sandboxAuthToken", value);
            if (authStatus) {
              authStatus.textContent = "Token stored for UI & curl.";
            }
          } else {
            window.localStorage.removeItem("sandboxAuthToken");
            if (authStatus) {
              authStatus.textContent = "";
            }
          }
        });
      })();

      // ----- Tabs -----
      const tabButtons = document.querySelectorAll(".tab");
      const tabContents = document.querySelectorAll(".tab-content");

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.getAttribute("data-tab");
          if (!tab) return;

          tabButtons.forEach((b) => b.classList.remove("active"));
          tabContents.forEach((c) => c.classList.remove("active"));

          btn.classList.add("active");
          const content = document.getElementById(`tab-${tab}`);
          if (content) {
            content.classList.add("active");
          }
        });
      });

      // ----- Config form -----
      const configForm = document.getElementById("config-form");
      const configStatus = document.getElementById("config-status");
      const generateTokenButton = document.getElementById(
        "generateTokenButton"
      );

      async function loadConfig() {
        try {
          const cfg = await getJson("/api/config");
          configForm.targetWebhookUrl.value = cfg.targetWebhookUrl || "";
          configForm.verifyToken.value = cfg.verifyToken || "";
          if (cfg.auth) {
            configForm.authMode.value = cfg.auth.mode || "none";
            configForm.jwtIssuer.value = cfg.auth.jwtIssuer || "";
            configForm.jwtAudience.value = cfg.auth.jwtAudience || "";
            configForm.jwtSecret.value = cfg.auth.jwtSecret || "";
          }
        } catch (err) {
          configStatus.textContent = "Failed to load config";
          console.error(err);
        }
      }

      configForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        configStatus.textContent = "Saving…";
        try {
          const payload = {
            targetWebhookUrl:
              configForm.targetWebhookUrl.value.trim() || null,
            verifyToken: configForm.verifyToken.value.trim() || undefined,
            auth: {
              mode: configForm.authMode.value,
              jwtIssuer: configForm.jwtIssuer.value.trim() || undefined,
              jwtAudience: configForm.jwtAudience.value.trim() || undefined,
              jwtSecret: configForm.jwtSecret.value.trim() || undefined,
            },
          };
          const updated = await putJson("/api/config", payload);
          configStatus.textContent = "Saved.";
          console.log("Config updated", updated);
        } catch (err) {
          configStatus.textContent = "Error saving config.";
          console.error(err);
        }
      });

      if (generateTokenButton) {
        generateTokenButton.addEventListener("click", async (e) => {
          e.preventDefault();
          if (authStatus) {
            authStatus.textContent = "Generating token…";
          }
          try {
            const res = await fetch("/api/auth/token", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({}),
            });
            const data = await res.json();
            if (authTokenInput && data.token) {
              authTokenInput.value = data.token;
              window.localStorage.setItem("sandboxAuthToken", data.token);
            }
            if (authStatus) {
              authStatus.textContent =
                "Token generated. It will be sent as Authorization: Bearer …";
            }
          } catch (err) {
            if (authStatus) {
              authStatus.textContent = "Failed to generate token.";
            }
            console.error(err);
          }
        });
      }

      // ----- Simulation forms -----
      document
        .getElementById("message-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const data = {
            from: form.from.value,
            body: form.body.value,
            name: form.name.value || undefined,
            waId: form.waId.value || undefined,
            // Optional: you can wire phoneNumberId/wabaId here later
          };
          output.textContent = "Sending /simulate/message …";
          try {
            const res = await postJson("/simulate/message", data);
            output.textContent =
              "Status " + res.status + "\n\n" + res.data;
          } catch (err) {
            output.textContent = String(err);
          }
        });

      document
        .getElementById("status-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const data = {
            messageId: form.messageId.value,
            recipientId: form.recipientId.value,
            status: form.status.value,
          };
          output.textContent = "Sending /simulate/status …";
          try {
            const res = await postJson("/simulate/status", data);
            output.textContent =
              "Status " + res.status + "\n\n" + res.data;
          } catch (err) {
            output.textContent = String(err);
          }
        });

      document
        .getElementById("image-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const data = {
            from: form.fromImage.value,
            caption: form.captionImage.value || undefined,
            mediaUrl:
              form.mediaUrlImage.value ||
              "http://localhost:3737/media/sample-image.png",
          };
          output.textContent = "Sending /simulate/image …";
          try {
            const res = await postJson("/simulate/image", data);
            output.textContent =
              "Status " + res.status + "\n\n" + res.data;
          } catch (err) {
            output.textContent = String(err);
          }
        });

      document
        .getElementById("document-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const data = {
            from: form.fromDocument.value,
            filename: form.filenameDocument.value || undefined,
            caption: form.captionDocument.value || undefined,
            mediaUrl:
              form.mediaUrlDocument.value ||
              "http://localhost:3737/media/sample-document.pdf",
          };
          output.textContent = "Sending /simulate/document …";
          try {
            const res = await postJson("/simulate/document", data);
            output.textContent =
              "Status " + res.status + "\n\n" + res.data;
          } catch (err) {
            output.textContent = String(err);
          }
        });

      document
        .getElementById("audio-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const data = {
            from: form.fromAudio.value,
            mediaUrl:
              form.mediaUrlAudio.value ||
              "http://localhost:3737/media/sample-audio.ogg",
            voice: form.voiceAudio.checked,
          };
          output.textContent = "Sending /simulate/audio …";
          try {
            const res = await postJson("/simulate/audio", data);
            output.textContent =
              "Status " + res.status + "\n\n" + res.data;
          } catch (err) {
            output.textContent = String(err);
          }
        });

      // ----- Live events via SSE -----
      const eventsStatus = document.getElementById("events-status");
      const eventsList = document.getElementById("events-list");

      function renderEvent(evt) {
        if (!evt) return;
        const row = document.createElement("div");
        row.className = "event-row";
        const time = new Date(evt.timestamp).toLocaleTimeString();
        const header = document.createElement("div");
        header.className = "event-header";

        const timeEl = document.createElement("span");
        timeEl.className = "event-time";
        timeEl.textContent = time;

        const typeEl = document.createElement("span");
        typeEl.className = "event-type";
        typeEl.textContent = evt.type;

        const dirEl = document.createElement("span");
        dirEl.className =
          "event-direction " + (evt.direction || "system");
        dirEl.textContent = (evt.direction || "system").toUpperCase();

        const sourceEl = document.createElement("span");
        sourceEl.className = "event-source";
        sourceEl.textContent = evt.source;

        header.appendChild(timeEl);
        header.appendChild(typeEl);
        header.appendChild(dirEl);
        header.appendChild(sourceEl);

        const payloadEl = document.createElement("div");
        payloadEl.className = "event-payload";
        try {
          payloadEl.textContent = JSON.stringify(evt.payload, null, 2);
        } catch (_) {
          payloadEl.textContent = String(evt.payload);
        }

        row.appendChild(header);
        row.appendChild(payloadEl);

        eventsList.insertBefore(row, eventsList.firstChild);

        // Keep the latest 50 events
        while (eventsList.children.length > 50) {
          eventsList.removeChild(eventsList.lastChild);
        }
      }

      function connectEvents() {
        try {
          const es = new EventSource("/api/events/stream");
          eventsStatus.textContent = "Connected";

          es.addEventListener("bootstrap", (e) => {
            try {
              const data = JSON.parse(e.data);
              (data.events || []).forEach(renderEvent);
            } catch (err) {
              console.error("bootstrap parse error", err);
            }
          });

          es.addEventListener("event", (e) => {
            try {
              const data = JSON.parse(e.data);
              renderEvent(data);
            } catch (err) {
              console.error("event parse error", err);
            }
          });

          es.onerror = () => {
            eventsStatus.textContent = "Disconnected – retrying…";
            es.close();
            setTimeout(connectEvents, 3000);
          };
        } catch (err) {
          eventsStatus.textContent = "Unable to connect";
          console.error(err);
        }
      }

      // Initial bootstrap
      loadConfig();
      connectEvents();
    </script>
  </body>
  </html>
